---
title: "P8106 Midterm Project"
author: "Leyang Rui, Jinghan Zhao"
date: "2025-03-28"
output:
  pdf_document: default
  html_document: default
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(fig.width = 10, 
                      fig.height = 5,
                      out.width = "90%",
                      message = FALSE,
                      warning = FALSE)
set.seed(37)

library(tidyverse)
library(forcats)
library(corrplot)
library(caret)
library(mgcv)
library(earth)
library(rpart)
library(rpart.plot)
library(party)
library(partykit)
```

## Load Data

```{r load_data}
load("data/dat1.RData")
train_data = dat1 |>
  janitor::clean_names() |>
  mutate(
    gender = as.factor(gender),
    diabetes = as.factor(diabetes),
    hypertension = as.factor(hypertension),
    race = fct_recode(race,
                  White = "1",
                  Asian = "2",
                  Black = "3",
                  Hispanic = "4"),
    gender = fct_recode(gender,
                        Male = "1",
                        Female = "0"),
    smoking = fct_recode(smoking,
                         "Never smoked" = "0",
                         "Former smoker" = "1",
                         "Current smoker" = "2"))

load("data/dat2.RData")
test_data = dat2 |>
  janitor::clean_names() |>
  mutate(
    gender = as.factor(gender),
    diabetes = as.factor(diabetes),
    hypertension = as.factor(hypertension),
    race = fct_recode(race,
                  White = "1",
                  Asian = "2",
                  Black = "3",
                  Hispanic = "4"),
    gender = fct_recode(gender,
                        Male = "1",
                        Female = "0"),
    smoking = fct_recode(smoking,
                         "Never smoked" = "0",
                         "Former smoker" = "1",
                         "Current smoker" = "2")
  )

```

### Modify Data

```{r}
train_data1 = 
  train_data %>% 
  select(-id, -height, -weight, -hypertension)

x_train = model.matrix(log_antibody ~ ., train_data1)[, -1]
colnames(x_train) = make.names(colnames(x_train), unique = TRUE)

y_train = train_data1[, "log_antibody"]
ctrl1 = trainControl(method = "cv", number = 10)
```

## Descriptive Analysis

### Numeric Variables

```{r}
train_data |> 
  pivot_longer(
    cols = c(age, height, weight, bmi),
    names_to = "variable",
    values_to = "value"
  ) |>
  ggplot(aes(x = value, y = log_antibody, color = variable)) +
  geom_point(alpha = 0.5, size = 0.6) +
  facet_wrap(variable ~ .,  scales = "free") +
    labs(title = "Distribution of the Demographic Continuous Variables",
         x = "Variables",
         y = "Log_Antibody")

train_data |> 
  pivot_longer(
    cols = c(sbp, ldl, time),
    names_to = "variable",
    values_to = "value"
  ) |>
  ggplot(aes(x = value, y = log_antibody, color = variable)) +
  geom_point(alpha = 0.5, size = 0.6) +
  facet_wrap(variable ~ .,  scales = "free") +
    labs(title = "Distribution of the Clinical Continuous Variables",
         x = "Variables",
         y = "Log_Antibody")
```

```{r}
train_data %>% 
  pivot_longer(
    cols = c(age, height, weight, bmi, sbp, ldl, time, log_antibody),
    names_to = "variable_name",
    values_to = "value"
  ) %>% 
  group_by(variable_name) %>% 
  summarize(
    mean = mean(value),
    median = median(value),
    min = min(value),
    first_quantile = quantile(value, probs = 0.25),
    third_quantile = quantile(value, probs = 0.75),
    max = max(value)
  ) %>% 
  ungroup() %>% 
  arrange(desc(variable_name == "log_antibody"), variable_name) %>% 
  knitr::kable(digits = 3, caption = "Descriptive Statistics")
```


### Categorical Variables

```{r}
train_data |> 
  pivot_longer(
    cols = c(gender, race, smoking, diabetes, hypertension),
    names_to = "variable",
    values_to = "value"
  ) |>
  mutate(
    variable = factor(variable, levels = c("gender", "race", "smoking", "diabetes", "hypertension"))
  ) |>
  ggplot(aes(x = value, y = log_antibody, fill = variable)) +
  geom_boxplot(alpha = 0.5) +
  facet_wrap(variable ~ .,  scales = "free") +
    labs(title = "Distribution of the Categorical Variables",
         x = "Variables",
         y = "Log_Antibody") +
  theme(axis.text.x = element_text(angle = 30, vjust = 1, hjust = 1))
```


### Correlation Plot

```{r}
corrplot(cor(x_train), method = "circle", type = "full")
```



## Regression


### Elastic Net

### PCR and PLS

### GAM and MARS

```{r, GAM}
set.seed(37)

gam.fit = train(x_train, y_train,
                 method = "gam", 
                 trControl = ctrl1)

gam.fit$bestTune
gam.fit$finalModel

plot(gam.fit$finalModel)
```

```{r, MARS}
set.seed(37)

mars_grid = expand.grid(degree = 1:3,
                        nprune = 2:12)

mars.fit = train(x_train, y_train,
                 method = "earth",
                 tuneGrid = mars_grid,
                 trControl = ctrl1)

ggplot(mars.fit)

mars.fit$bestTune
coef(mars.fit$finalModel)
```

### Regression Trees

```{r}
set.seed(37)

tree_full = rpart(formula = log_antibody ~ ., data = train_data1,
                  control = rpart.control(cp = 0))

printcp(tree_full)
cpTable = tree_full$cptable
plotcp(tree_full)

## Find the cp that yields the minimum cross-validation error
minErr = which.min(cpTable[,4])
tree_final = rpart::prune(tree_full, cp = cpTable[minErr, 1])
rpart.plot(tree_final)

summary(tree_final)
```

